import streamlit as st
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.colors import HexColor
import os
import urllib.request
from datetime import datetime

# ページ設定
st.set_page_config(
    page_title="2026年運勢鑑定書",
    layout="centered"
)

# フォントファイルのパス
FONT_DIR = "fonts"
FONT_PATH = os.path.join(FONT_DIR, "ipaexm.ttf")

def download_font():
    """IPAex明朝フォントをダウンロードする"""
    if not os.path.exists(FONT_DIR):
        os.makedirs(FONT_DIR)
    
    if not os.path.exists(FONT_PATH):
        font_url = "https://raw.githubusercontent.com/making/demo-jasper-report-ja/master/src/main/resources/fonts/ipaexm/ipaexm.ttf"
        try:
            urllib.request.urlretrieve(font_url, FONT_PATH)
            # st.success("フォントをダウンロードしました") # 毎回出ると邪魔なのでコメントアウト
        except Exception as e:
            st.error(f"フォントのダウンロードに失敗しました: {e}")
            return False
    return True

def register_font():
    """フォントをReportLabに登録する"""
    if os.path.exists(FONT_PATH):
        try:
            pdfmetrics.registerFont(TTFont('IPAexMincho', FONT_PATH))
            return True
        except Exception as e:
            st.error(f"フォントの登録に失敗しました: {e}")
            return False
    return False

# ==========================================
# 日本語対応の折り返し関数
# ==========================================
def draw_wrapped_text(c, text, x, y, max_width, font_name, font_size, line_height, color=HexColor("#333333")):
    """長い日本語テキストを指定幅で折り返して描画し、書き終わったY座標を返す"""
    c.setFillColor(color)
    c.setFont(font_name, font_size)
    
    lines = []
    current_line = ""
    
    for char in text:
        if c.stringWidth(current_line + char, font_name, font_size) <= max_width:
            current_line += char
        else:
            lines.append(current_line)
            current_line = char
    if current_line:
        lines.append(current_line)
    
    for line in lines:
        if y < 50: break
        c.drawString(x, y, line)
        y -= line_height
    return y

# -------------------------------------------------
# 運勢ロジック
# -------------------------------------------------
def calculate_life_path_number(year, month, day):
    def sum_digits(n):
        while n >= 10:
            n = sum(int(d) for d in str(n))
        return n
    total = sum_digits(year) + sum_digits(month) + sum_digits(day)
    life_path = sum_digits(total)
    if total in [11, 22, 33]: return total
    return life_path

def get_personality(life_path):
    personalities = {
        1: "あなたには、自然と人を導く力が備わっている傾向があります。独立心が強く、新しいことに挑戦する勇気をお持ちのようです。自分らしさを大切にしながら、周囲の人々にも良い影響を与えられる存在として輝いていらっしゃることでしょう。リーダーとしての資質を活かし、周囲の人々を導きながら、自分自身も成長していかれることでしょう。",
        2: "感受性が豊かで、人の気持ちを深く理解できる優しさをお持ちのようです。協調性があり、周囲との調和を大切にされる傾向があります。その繊細な心は、あなたの大きな魅力となっています。パートナーシップを大切にし、お互いを尊重し合う関係を築くことで、より豊かな人生を歩まれていくことでしょう。",
        3: "創造性と表現力に恵まれ、芸術的な才能やコミュニケーション能力が高い傾向があります。あなたのアイデアや言葉は、周囲の人々に喜びと感動を与える力を持っているようです。その才能を存分に発揮することで、多くの人々に希望とインスピレーションを与える存在となっていくことでしょう。",
        4: "誠実で責任感が強く、実務的な能力に優れている傾向があります。安定を好み、着実に物事を進める力をお持ちのようです。その真面目さと信頼性は、周囲から高く評価されていることでしょう。着実な努力を積み重ねることで、長期的な成功と安定を手に入れられる可能性が高いでしょう。",
        5: "自由を愛し、好奇心旺盛なあなたは、変化を楽しみながら多様な経験を求められる傾向があります。その柔軟性と冒険心は、人生を豊かに彩る力となっているようです。新しい環境や挑戦を通じて、自分自身の可能性を広げていかれることでしょう。",
        6: "愛情深く、奉仕の精神が強いあなたは、家族や友人を大切にし、調和を重んじる傾向があります。その優しさと献身的な姿勢は、周囲の人々に安心感を与えていることでしょう。人々の幸せを願う心が、あなた自身の幸せにもつながっていくことでしょう。",
        7: "分析的で内省的、スピリチュアルな探求や深い思考を好まれる傾向があります。その洞察力と直感は、人生の本質を見抜く力となっているようです。静かな時間を大切にしながら、内面の成長を深めていくことで、より豊かな人生を歩まれていくことでしょう。",
        8: "実力があり、成功への意欲が強い傾向があります。ビジネスセンスに優れ、権威を築く力をお持ちのようです。その努力と才能は、着実に実を結んでいくことでしょう。目標を明確にし、計画的に行動することで、大きな成果を手に入れられる可能性が高いでしょう。",
        9: "博愛主義で理想が高く、人々のために貢献することを喜びとされる傾向があります。その慈愛に満ちた心は、多くの人々に希望と勇気を与える力となっているようです。理想を追い求めながら、現実的な行動を重ねることで、多くの人々に影響を与える存在となっていくことでしょう。",
        11: "直感力が鋭く、インスピレーションに富まれている傾向があります。スピリチュアルな導き手としての資質をお持ちのようです。その直感を信じて行動されることで、素晴らしい道が開けていくことでしょう。内なる声に耳を傾けながら、スピリチュアルな導きに従うことで、より高い次元の成功を手に入れられる可能性が高いでしょう。",
        22: "実践的な理想主義者として、大きなビジョンを現実化する力をお持ちの傾向があります。その理想と実践力のバランスは、多くの人々に希望を与える存在となっているようです。大きな夢を描きながら、着実に行動を重ねることで、理想を現実のものとしていかれることでしょう。",
        33: "慈愛に満ちた教師として、多くの人々を導き、癒す力を持たれている傾向があります。その優しさと知恵は、周囲の人々に深い影響を与える特別な存在となっているようです。多くの人々の成長と幸せを願いながら、自分自身も成長し続けていくことで、より大きな使命を果たしていかれることでしょう。"
    }
    return personalities.get(life_path, "独特な個性を持ち、独自の道を歩んでいらっしゃるようです。その個性を大切にしながら、自分らしい人生を切り拓いていかれることでしょう。")

def get_fortune(life_path):
    fortunes = {
        1: ("大吉", "2026年は、あなたにとって新しいスタートの年となる傾向があります。積極的に行動されることで、大きな成果が期待できるでしょう。これまでに培ってきた経験と勇気を糧に、一歩ずつ前に進まれることをお勧めいたします。リーダーシップを発揮する場面が増え、周囲からも信頼される存在となっていくことでしょう。"),
        2: ("中吉", "2026年は、協力関係が特に重要となる年となりそうです。パートナーシップを大切にされることで、運気が上昇していく傾向があります。周囲の人々との信頼関係を深めながら、共に成長していかれると良いでしょう。一人で抱え込まず、協力し合うことで、より大きな成果を手に入れられる可能性が高いでしょう。"),
        3: ("大吉", "2026年は、あなたの創造性が開花する年となる傾向があります。表現活動やコミュニケーションを通じて、成功のチャンスが訪れる可能性が高いでしょう。自分らしさを大切にしながら、その才能を存分に発揮されると良いでしょう。アイデアが次々と実現し、周囲からも高く評価される年となりそうです。"),
        4: ("中吉", "2026年は、着実な成長の年となりそうです。努力を積み重ねることで、安定した成果を得られる傾向があります。焦らず、一歩ずつ進まれることで、確かな実りが待っていることでしょう。責任ある立場での活躍が期待でき、周囲からの信頼も深まっていくことでしょう。"),
        5: ("小吉", "2026年は、変化と自由の年となる傾向があります。新しい環境や経験が、あなたの運気を高める可能性が高いでしょう。柔軟な心で、これまでとは違う世界に目を向けてみられると良いかもしれません。変化を恐れず、新しい挑戦に取り組むことで、運気が上昇していくことでしょう。"),
        6: ("中吉", "2026年は、愛情と調和の年となりそうです。人間関係が深まり、心の豊かさが増していく傾向があります。大切な人との時間を大切にしながら、温かい絆を育んでいかれると良いでしょう。家族や友人との関係がより深まり、心の支えとなる存在が増えていくことでしょう。"),
        7: ("小吉", "2026年は、内面の探求の年となる傾向があります。スピリチュアルな成長と深い洞察が得られる可能性が高いでしょう。静かな時間を大切にしながら、自分自身と向き合うことで、新たな気づきが訪れることでしょう。内面の成長が、外側の世界にも良い影響を与えていくことでしょう。"),
        8: ("大吉", "2026年は、成功と達成の年となる傾向があります。ビジネスやキャリアにおいて、大きな飛躍が期待できるでしょう。これまでの努力が実を結び、新たなステージへと進まれる可能性が高い年となりそうです。権威や地位が向上し、周囲からも高く評価されることでしょう。"),
        9: ("中吉", "2026年は、完成と新たな始まりの年となる傾向があります。これまでの努力が実を結び、次のステップへと進む準備が整う可能性が高いでしょう。過去を振り返りながら、未来への希望を胸に歩まれると良いでしょう。理想を実現するための基盤が整い、新たな挑戦への準備が整う年となりそうです。"),
        11: ("大吉", "2026年は、直感とインスピレーションが強く働く年となる傾向があります。スピリチュアルな導きが、あなたの人生をより良い方向へと導いてくれる可能性が高いでしょう。内なる声に耳を傾けながら、その導きに従って行動されると良いでしょう。直感を信じることで、運命的な出会いやチャンスが訪れることでしょう。"),
        22: ("大吉", "2026年は、大きなビジョン実現の年となる傾向があります。理想を現実化する力が最大限に発揮される可能性が高いでしょう。これまでに描いてきた夢を、着実に形にしていかれると良いでしょう。大きなプロジェクトの成功が期待でき、多くの人々に影響を与える存在となっていくことでしょう。"),
        33: ("大吉", "2026年は、慈愛と癒しの年となる傾向があります。多くの人々に影響を与える特別な年となりそうです。あなたの優しさと知恵が、周囲の人々に希望と勇気を与える力となっていくことでしょう。多くの人々を導き、癒すことで、自分自身も成長していくことでしょう。")
    }
    return fortunes.get(life_path, ("中吉", "2026年は、バランスの取れた一年となる傾向があります。日々の努力が運気を高め、着実に前進していかれることでしょう。焦らず、自分らしいペースで歩まれると良いでしょう。"))

def get_love_fortune(life_path):
    love_fortunes = {
        1: (4, "2026年は、積極的なアプローチが成功の鍵となる傾向があります。新しい出会いを求めて行動されることで、素晴らしい出会いが訪れる可能性が高いでしょう。自分らしさを大切にしながら、勇気を持って一歩を踏み出されると良いでしょう。リーダーシップを発揮するあなたの魅力が、多くの人々を引き寄せることでしょう。"),
        2: (5, "2026年は、パートナーシップが深まる年となる傾向があります。相手の気持ちに寄り添うことで、関係がより深く発展していく可能性が高いでしょう。お互いを尊重し合いながら、温かい愛情を育んでいかれると良いでしょう。感受性豊かなあなたの優しさが、パートナーとの絆をより強くしていくことでしょう。"),
        3: (5, "2026年は、コミュニケーションが特に重要となる年となりそうです。楽しい会話を通じて、関係が深まっていく傾向があります。あなたの表現力と明るさが、パートナーとの絆をより強くしていくことでしょう。創造的なデートや会話を通じて、お互いの理解が深まっていくことでしょう。"),
        4: (3, "2026年は、安定した関係を築く年となる傾向があります。誠実さと信頼が、あなたの恋愛運を高めていく可能性が高いでしょう。焦らず、着実に信頼関係を深めていかれると良いでしょう。真面目で誠実なあなたの姿勢が、パートナーからの信頼を深めていくことでしょう。"),
        5: (4, "2026年は、新しい出会いのチャンスが訪れる年となりそうです。自由な心で恋愛を楽しまれることで、素晴らしい出会いが待っている可能性が高いでしょう。固定観念にとらわれず、新しい可能性に目を向けてみられると良いでしょう。変化を楽しむあなたの姿勢が、新しい出会いを引き寄せることでしょう。"),
        6: (5, "2026年は、愛情が深まる年となる傾向があります。家族やパートナーとの絆が、より強く深くなっていく可能性が高いでしょう。お互いを大切にしながら、温かい時間を共有されると良いでしょう。愛情深いあなたの姿勢が、周囲の人々との関係をより豊かにしていくことでしょう。"),
        7: (3, "2026年は、内面の成長が恋愛運を高める年となりそうです。深いつながりを求められることで、真のパートナーシップが築かれる可能性が高いでしょう。表面的な関係ではなく、心の奥底でつながる関係を大切にされると良いでしょう。内面の成長が、より深い愛情を育んでいくことでしょう。"),
        8: (4, "2026年は、魅力的なあなたに注目が集まる年となる傾向があります。自信を持って行動されることで、素晴らしい出会いが訪れる可能性が高いでしょう。あなたの実力と魅力が、自然と良い出会いを引き寄せていくことでしょう。成功への意欲が、あなたの魅力をさらに高めていくことでしょう。"),
        9: (4, "2026年は、理想のパートナーとの出会いの可能性が高い年となりそうです。広い視野で探されることで、心から理解し合える相手と出会える可能性があります。理想を大切にしながら、柔軟な心で出会いを待たれると良いでしょう。博愛主義のあなたの姿勢が、理想的なパートナーを引き寄せることでしょう。"),
        11: (5, "2026年は、直感に従うことで素晴らしい出会いが訪れる年となる傾向があります。内なる声を信じて行動されることで、運命的な出会いが待っている可能性が高いでしょう。スピリチュアルな導きに従いながら、自然な流れに任せられると良いでしょう。直感を信じることで、真のパートナーと出会えることでしょう。"),
        22: (5, "2026年は、理想的なパートナーシップが実現する可能性が高い年となりそうです。これまでに描いてきた理想の関係が、現実のものとなる可能性があります。お互いを尊重し合いながら、共に成長していかれると良いでしょう。大きなビジョンを共有できるパートナーと出会える可能性が高いでしょう。"),
        33: (5, "2026年は、深い愛情と理解に満ちた関係が築かれる年となる傾向があります。あなたの優しさと慈愛が、パートナーとの絆をより深くしていく可能性が高いでしょう。お互いを癒し合いながら、温かい愛情を育んでいかれると良いでしょう。多くの人々を導くあなたの姿勢が、パートナーとの関係もより深くしていくことでしょう。")
    }
    return love_fortunes.get(life_path, (3, "2026年は、バランスの取れた恋愛運となる傾向があります。自然な流れに任せながら、自分らしさを大切にされると良いでしょう。焦らず、心を開いて出会いを待たれると良いでしょう。"))

def get_work_fortune(life_path):
    work_fortunes = {
        1: (5, "2026年は、リーダーシップを発揮する年となる傾向があります。新しいプロジェクトで成功を収められる可能性が高いでしょう。あなたの決断力と行動力が、周囲から高く評価されていくことでしょう。自信を持って、リーダーとしての役割を担われると良いでしょう。独立心の強さが、新しいビジネスチャンスを生み出すことでしょう。"),
        2: (4, "2026年は、チームワークが特に重要となる年となりそうです。協力関係を大切にされることで、成果が上がっていく傾向があります。あなたの協調性と感受性が、チーム全体の力を引き出す鍵となることでしょう。パートナーシップを大切にすることで、より大きな成果を手に入れられる可能性が高いでしょう。"),
        3: (5, "2026年は、創造的な仕事で評価される年となる傾向があります。アイデアが次々と実現していく可能性が高いでしょう。あなたの表現力と創造性が、仕事の成果を大きく左右していくことでしょう。コミュニケーション能力を活かし、多くの人々に影響を与える仕事ができることでしょう。"),
        4: (4, "2026年は、着実な努力が認められる年となりそうです。責任ある立場での活躍が期待できる傾向があります。これまでに積み重ねてきた努力が、実を結んでいくことでしょう。誠実さと責任感が、周囲からの信頼を深めていくことでしょう。安定した成果を手に入れられる可能性が高いでしょう。"),
        5: (3, "2026年は、変化とチャレンジの年となる傾向があります。新しい分野への挑戦が、あなたの運気を高めていく可能性が高いでしょう。柔軟な心で、これまでとは違う世界に飛び込まれると良いでしょう。変化を楽しむ姿勢が、新しいビジネスチャンスを生み出すことでしょう。"),
        6: (4, "2026年は、サービス精神が評価される年となる傾向があります。人のために働くことで、成果が得られていく可能性が高いでしょう。あなたの優しさと献身的な姿勢が、周囲から感謝され、評価されていくことでしょう。人々の幸せを願う姿勢が、仕事の成果にもつながっていくことでしょう。"),
        7: (4, "2026年は、分析力と研究が光る年となりそうです。専門性を高めることで、評価が上がっていく傾向があります。深い洞察力と探究心が、あなたの仕事に新たな価値を生み出していくことでしょう。内面の探求が、仕事の質を高めていくことでしょう。"),
        8: (5, "2026年は、ビジネスで大きな成功を収める年となる傾向があります。権威や地位が向上していく可能性が高いでしょう。これまでの努力と実力が、目に見える形で実を結んでいくことでしょう。成功への意欲が、より大きな成果を生み出すことでしょう。"),
        9: (4, "2026年は、理想を実現する年となる傾向があります。社会貢献につながる仕事で、成果を上げられる可能性が高いでしょう。あなたの理想と情熱が、多くの人々に希望を与える仕事となっていくことでしょう。博愛主義の姿勢が、仕事の成果にもつながっていくことでしょう。"),
        11: (5, "2026年は、インスピレーションが仕事を導く年となる傾向があります。直感を信じて行動されることで、素晴らしい成果が得られる可能性が高いでしょう。スピリチュアルな導きに従いながら、創造的な仕事を進められると良いでしょう。直感を信じることで、新しいビジネスチャンスが生まれることでしょう。"),
        22: (5, "2026年は、大きなプロジェクトの成功が期待できる年となりそうです。理想を現実化する力が、最大限に発揮される傾向があります。これまでに描いてきた大きなビジョンが、着実に形になっていくことでしょう。実践的な理想主義の姿勢が、大きな成果を生み出すことでしょう。"),
        33: (5, "2026年は、多くの人々に影響を与える仕事で成功する年となる傾向があります。あなたの慈愛と知恵が、仕事を通じて多くの人々に希望と勇気を与えていくことでしょう。多くの人々を導き、癒すことで、自分自身も成長していくことでしょう。教師としての資質が、仕事の成果にもつながっていくことでしょう。")
    }
    return work_fortunes.get(life_path, (3, "2026年は、バランスの取れた仕事運となる傾向があります。日々の努力が実を結び、着実に前進していかれることでしょう。焦らず、自分らしいペースで仕事を進められると良いでしょう。"))

def get_money_fortune(life_path):
    """金運を取得"""
    money_fortunes = {
        1: (4, "2026年は、積極的な投資や新しいビジネスチャンスが金運を高める年となる傾向があります。リーダーシップを発揮することで、収入が増える可能性が高いでしょう。ただし、計画性を持って行動されることをお勧めいたします。大胆な行動と慎重な判断のバランスが、金運をさらに高めていくことでしょう。"),
        2: (4, "2026年は、パートナーシップを通じて金運が上がる年となる傾向があります。協力関係を大切にすることで、収入のチャンスが広がっていく可能性が高いでしょう。共同事業や協力関係が、金運を高めていくことでしょう。お互いを尊重し合う関係が、経済的な成功につながっていくことでしょう。"),
        3: (5, "2026年は、創造的な才能が金運を高める年となる傾向があります。表現活動やコミュニケーションを通じて、収入のチャンスが訪れる可能性が高いでしょう。アイデアを形にすることで、経済的な成功を手に入れられることでしょう。あなたの才能が、多くの人々に価値を提供し、収入につながっていくことでしょう。"),
        4: (4, "2026年は、着実な貯蓄と計画的な投資が金運を高める年となる傾向があります。安定した収入を基盤に、計画的に資産を増やしていかれると良いでしょう。真面目で誠実な姿勢が、経済的な安定をもたらしていくことでしょう。長期的な視点で資産を築いていくことで、将来の金運が高まっていくことでしょう。"),
        5: (3, "2026年は、変化と新しいチャンスが金運を高める年となる傾向があります。新しい投資先やビジネスチャンスに目を向けてみられると良いでしょう。柔軟な姿勢が、予想外の収入源を生み出す可能性があります。ただし、リスク管理も忘れずに、慎重に判断されることをお勧めいたします。"),
        6: (4, "2026年は、人々の幸せを願う姿勢が金運を高める年となる傾向があります。サービス精神を大切にすることで、収入のチャンスが広がっていく可能性が高いでしょう。人のために働く姿勢が、経済的な成功につながっていくことでしょう。愛情深い姿勢が、多くの人々から信頼され、収入につながっていくことでしょう。"),
        7: (3, "2026年は、専門性を高めることで金運が上がる年となる傾向があります。深い知識やスキルを身につけることで、収入のチャンスが広がっていく可能性が高いでしょう。内面の成長が、経済的な成功につながっていくことでしょう。分析力と探究心が、新しい収入源を生み出すことでしょう。"),
        8: (5, "2026年は、ビジネスで大きな成功を収め、金運が大幅に上がる年となる傾向があります。権威や地位が向上することで、収入も増えていく可能性が高いでしょう。これまでの努力が、経済的な成功として実を結んでいくことでしょう。成功への意欲が、より大きな収入を生み出すことでしょう。"),
        9: (4, "2026年は、理想を実現することで金運が高まる年となる傾向があります。社会貢献につながる仕事が、経済的な成功にもつながっていく可能性が高いでしょう。博愛主義の姿勢が、多くの人々から支持され、収入につながっていくことでしょう。理想を追い求める姿勢が、経済的な成功をもたらしていくことでしょう。"),
        11: (4, "2026年は、直感を信じることで金運が高まる年となる傾向があります。スピリチュアルな導きに従うことで、収入のチャンスが訪れる可能性が高いでしょう。内なる声に耳を傾けることで、新しい収入源を見つけられることでしょう。直感を信じることで、予想外の経済的な成功を手に入れられる可能性があります。"),
        22: (5, "2026年は、大きなビジョンを実現することで金運が大幅に上がる年となる傾向があります。理想を現実化する力が、経済的な成功にもつながっていく可能性が高いでしょう。大きなプロジェクトの成功が、収入の大幅な増加をもたらしていくことでしょう。実践的な理想主義の姿勢が、経済的な成功を生み出すことでしょう。"),
        33: (4, "2026年は、多くの人々に影響を与えることで金運が高まる年となる傾向があります。あなたの慈愛と知恵が、経済的な成功にもつながっていく可能性が高いでしょう。多くの人々を導き、癒すことで、収入のチャンスが広がっていくことでしょう。教師としての資質が、経済的な成功にもつながっていくことでしょう。")
    }
    return money_fortunes.get(life_path, (3, "2026年は、バランスの取れた金運となる傾向があります。計画的な貯蓄と投資が、金運を高めていくことでしょう。焦らず、着実に資産を築いていかれると良いでしょう。"))

def get_health_fortune(life_path):
    """健康運を取得"""
    health_fortunes = {
        1: (4, "2026年は、積極的な運動や新しい健康習慣が健康運を高める年となる傾向があります。リーダーシップを発揮する場面が増えるため、体力を維持することが重要です。適度な運動とバランスの取れた食事が、健康を保つ鍵となることでしょう。新しいスポーツや健康法に挑戦してみられると良いでしょう。"),
        2: (4, "2026年は、心の健康が特に重要となる年となりそうです。ストレスをため込まず、周囲の人々との調和を大切にすることで、健康運が高まっていく傾向があります。リラックスできる時間を大切にし、心のバランスを保つことが重要です。パートナーシップを大切にすることで、心の健康も保たれていくことでしょう。"),
        3: (5, "2026年は、創造的な活動が健康運を高める年となる傾向があります。表現活動やコミュニケーションを通じて、心身ともに健康を保てる可能性が高いでしょう。楽しい活動が、健康を維持する鍵となることでしょう。明るい気持ちで過ごすことで、免疫力も高まっていくことでしょう。"),
        4: (4, "2026年は、規則正しい生活習慣が健康運を高める年となる傾向があります。着実に健康管理を続けることで、長期的な健康を手に入れられる可能性が高いでしょう。真面目で誠実な姿勢が、健康維持にもつながっていくことでしょう。計画的な健康管理が、将来の健康を保つことでしょう。"),
        5: (3, "2026年は、変化と新しい環境が健康運に影響を与える年となる傾向があります。新しい健康習慣に挑戦してみられると良いでしょう。ただし、無理をせず、自分のペースで健康管理を続けられることをお勧めいたします。柔軟な姿勢が、健康維持の鍵となることでしょう。"),
        6: (5, "2026年は、愛情深い姿勢が健康運を高める年となる傾向があります。家族や友人との時間を大切にすることで、心身ともに健康を保てる可能性が高いでしょう。温かい人間関係が、健康を維持する鍵となることでしょう。愛情深い姿勢が、免疫力も高めていくことでしょう。"),
        7: (4, "2026年は、内面の探求が健康運を高める年となる傾向があります。静かな時間を大切にし、心のバランスを保つことが重要です。スピリチュアルな活動が、健康を維持する鍵となることでしょう。内面の成長が、心身の健康にもつながっていくことでしょう。"),
        8: (4, "2026年は、成功への意欲が健康運に影響を与える年となる傾向があります。仕事に集中しすぎず、適度な休息を取ることが重要です。バランスの取れた生活が、健康を維持する鍵となることでしょう。成功を追求しながらも、健康管理を忘れないことが大切です。"),
        9: (4, "2026年は、理想を追い求める姿勢が健康運を高める年となる傾向があります。社会貢献につながる活動が、心身ともに健康を保つ鍵となることでしょう。博愛主義の姿勢が、健康を維持する力となっていくことでしょう。理想を実現する過程で、健康も保たれていくことでしょう。"),
        11: (4, "2026年は、直感を信じることで健康運が高まる年となる傾向があります。スピリチュアルな導きに従うことで、心身のバランスが保たれる可能性が高いでしょう。内なる声に耳を傾けることで、健康を維持する方法を見つけられることでしょう。直感を信じることで、健康管理も自然とできるようになることでしょう。"),
        22: (5, "2026年は、大きなビジョンを実現する過程で健康運が高まる年となる傾向があります。理想を現実化する力が、健康維持にもつながっていく可能性が高いでしょう。大きなプロジェクトの成功が、心身の健康も保つことでしょう。実践的な理想主義の姿勢が、健康を維持する力となっていくことでしょう。"),
        33: (5, "2026年は、多くの人々に影響を与えることで健康運が高まる年となる傾向があります。あなたの慈愛と知恵が、健康維持にもつながっていく可能性が高いでしょう。多くの人々を導き、癒すことで、自分自身の健康も保たれていくことでしょう。教師としての資質が、健康維持にもつながっていくことでしょう。")
    }
    return health_fortunes.get(life_path, (3, "2026年は、バランスの取れた健康運となる傾向があります。規則正しい生活習慣と適度な運動が、健康を維持する鍵となることでしょう。焦らず、自分のペースで健康管理を続けられると良いでしょう。"))

def get_relationship_fortune(life_path):
    """対人運を取得"""
    relationship_fortunes = {
        1: (4, "2026年は、リーダーシップを発揮することで対人運が高まる年となる傾向があります。周囲の人々から信頼され、多くの人々との関係が深まっていく可能性が高いでしょう。積極的に行動することで、新しい出会いも増えていくことでしょう。独立心の強さが、多くの人々を引き寄せることでしょう。"),
        2: (5, "2026年は、協調性と感受性が対人運を高める年となる傾向があります。周囲の人々との調和を大切にすることで、多くの人々との関係が深まっていく可能性が高いでしょう。パートナーシップを大切にすることで、対人運がさらに高まっていくことでしょう。優しさと協調性が、多くの人々から愛される存在となっていくことでしょう。"),
        3: (5, "2026年は、コミュニケーション能力が対人運を高める年となる傾向があります。表現力と明るさが、多くの人々との関係を深めていく可能性が高いでしょう。楽しい会話を通じて、新しい出会いも増えていくことでしょう。創造性と表現力が、多くの人々を引き寄せることでしょう。"),
        4: (3, "2026年は、誠実さと信頼性が対人運を高める年となる傾向があります。真面目で誠実な姿勢が、周囲の人々からの信頼を深めていく可能性が高いでしょう。着実に信頼関係を築いていくことで、対人運が高まっていくことでしょう。責任感の強さが、多くの人々から信頼される存在となっていくことでしょう。"),
        5: (4, "2026年は、変化と新しい出会いが対人運を高める年となる傾向があります。新しい環境や経験を通じて、多くの人々との関係が深まっていく可能性が高いでしょう。柔軟な姿勢が、新しい出会いを引き寄せることでしょう。自由を愛する姿勢が、多くの人々と良い関係を築いていくことでしょう。"),
        6: (5, "2026年は、愛情深い姿勢が対人運を高める年となる傾向があります。家族や友人を大切にすることで、多くの人々との関係が深まっていく可能性が高いでしょう。優しさと献身的な姿勢が、多くの人々から愛される存在となっていくことでしょう。愛情深い姿勢が、対人運をさらに高めていくことでしょう。"),
        7: (3, "2026年は、内面の成長が対人運を高める年となる傾向があります。深いつながりを求められることで、真の関係が築かれる可能性が高いでしょう。表面的な関係ではなく、心の奥底でつながる関係を大切にされると良いでしょう。内面の成長が、より深い人間関係を築いていくことでしょう。"),
        8: (4, "2026年は、実力と魅力が対人運を高める年となる傾向があります。成功への意欲が、多くの人々を引き寄せる可能性が高いでしょう。自信を持って行動されることで、新しい出会いも増えていくことでしょう。実力と魅力が、多くの人々から尊敬される存在となっていくことでしょう。"),
        9: (4, "2026年は、理想を追い求める姿勢が対人運を高める年となる傾向があります。博愛主義の姿勢が、多くの人々との関係を深めていく可能性が高いでしょう。社会貢献につながる活動を通じて、新しい出会いも増えていくことでしょう。理想を追い求める姿勢が、多くの人々から支持される存在となっていくことでしょう。"),
        11: (5, "2026年は、直感を信じることで対人運が高まる年となる傾向があります。スピリチュアルな導きに従うことで、運命的な出会いが訪れる可能性が高いでしょう。内なる声に耳を傾けることで、真の関係が築かれることでしょう。直感を信じることで、多くの人々と深いつながりを築いていくことでしょう。"),
        22: (5, "2026年は、大きなビジョンを共有することで対人運が高まる年となる傾向があります。理想を現実化する力が、多くの人々との関係を深めていく可能性が高いでしょう。大きなプロジェクトを通じて、新しい出会いも増えていくことでしょう。実践的な理想主義の姿勢が、多くの人々から支持される存在となっていくことでしょう。"),
        33: (5, "2026年は、多くの人々を導くことで対人運が高まる年となる傾向があります。あなたの慈愛と知恵が、多くの人々との関係を深めていく可能性が高いでしょう。多くの人々を導き、癒すことで、対人運がさらに高まっていくことでしょう。教師としての資質が、多くの人々から愛される存在となっていくことでしょう。")
    }
    return relationship_fortunes.get(life_path, (3, "2026年は、バランスの取れた対人運となる傾向があります。自然な流れに任せながら、自分らしさを大切にされると良いでしょう。焦らず、心を開いて出会いを待たれると良いでしょう。"))

def get_monthly_fortune(life_path):
    """月別運勢を取得"""
    monthly_fortunes = {
        1: {
            1: "1月は、新しいスタートに最適な月です。積極的に行動することで、大きな成果が期待できます。",
            2: "2月は、協力関係が重要となる月です。パートナーシップを大切にすることで、運気が上昇します。",
            3: "3月は、創造性が開花する月です。表現活動を通じて、成功のチャンスが訪れます。",
            4: "4月は、着実な成長の月です。努力を積み重ねることで、安定した成果を得られます。",
            5: "5月は、変化と自由の月です。新しい環境や経験が、運気を高めます。",
            6: "6月は、愛情と調和の月です。人間関係が深まり、心の豊かさが増します。",
            7: "7月は、内面の探求の月です。スピリチュアルな成長と深い洞察が得られます。",
            8: "8月は、成功と達成の月です。ビジネスやキャリアにおいて、大きな飛躍が期待できます。",
            9: "9月は、完成と新たな始まりの月です。これまでの努力が実を結びます。",
            10: "10月は、直感とインスピレーションが強く働く月です。スピリチュアルな導きが、人生を導きます。",
            11: "11月は、大きなビジョン実現の月です。理想を現実化する力が最大限に発揮されます。",
            12: "12月は、慈愛と癒しの月です。多くの人々に影響を与える特別な月となります。"
        },
        2: {
            1: "1月は、協力関係が特に重要となる月です。パートナーシップを大切にすることで、運気が上昇します。",
            2: "2月は、感受性が豊かになる月です。人の気持ちを深く理解することで、関係が深まります。",
            3: "3月は、調和を大切にする月です。周囲との協調が、運気を高めます。",
            4: "4月は、安定した関係を築く月です。誠実さと信頼が、運気を高めます。",
            5: "5月は、新しい出会いのチャンスが訪れる月です。自由な心で出会いを楽しみましょう。",
            6: "6月は、愛情が深まる月です。家族やパートナーとの絆が強くなります。",
            7: "7月は、内面の成長が対人運を高める月です。深いつながりを求めましょう。",
            8: "8月は、協力関係が成果を生む月です。チームワークが重要となります。",
            9: "9月は、完成と新たな始まりの月です。これまでの努力が実を結びます。",
            10: "10月は、直感に従うことで素晴らしい出会いがある月です。内なる声を信じましょう。",
            11: "11月は、理想的なパートナーシップが実現する月です。これまでに描いてきた理想の関係が、現実のものとなります。",
            12: "12月は、深い愛情と理解に満ちた関係が築かれる月です。優しさと慈愛が、絆を深めます。"
        },
        3: {
            1: "1月は、創造性が開花する月です。表現活動を通じて、成功のチャンスが訪れます。",
            2: "2月は、コミュニケーションが重要となる月です。楽しい会話で関係が深まります。",
            3: "3月は、アイデアが次々と実現する月です。創造的な活動が運気を高めます。",
            4: "4月は、表現力が光る月です。芸術的な才能が評価されます。",
            5: "5月は、新しい表現方法に挑戦する月です。創造性が開花します。",
            6: "6月は、コミュニケーション能力が高まる月です。表現力と明るさが、絆を深めます。",
            7: "7月は、内面の創造性が開花する月です。スピリチュアルな表現が運気を高めます。",
            8: "8月は、創造的な仕事で評価される月です。アイデアが次々と実現します。",
            9: "9月は、完成と新たな始まりの月です。これまでの創造活動が実を結びます。",
            10: "10月は、インスピレーションが強く働く月です。直感を信じて表現しましょう。",
            11: "11月は、大きなビジョンを表現する月です。理想を現実化する力が発揮されます。",
            12: "12月は、多くの人々に影響を与える表現活動ができる月です。創造性が多くの人々に希望を与えます。"
        },
        4: {
            1: "1月は、着実な成長の月です。努力を積み重ねることで、安定した成果を得られます。",
            2: "2月は、安定した関係を築く月です。誠実さと信頼が、運気を高めます。",
            3: "3月は、計画的な行動が重要となる月です。着実に物事を進めましょう。",
            4: "4月は、責任ある立場での活躍が期待できる月です。真面目さと信頼性が評価されます。",
            5: "5月は、変化に対応する月です。柔軟な姿勢が運気を高めます。",
            6: "6月は、安定した関係が深まる月です。誠実さと信頼が、絆を強めます。",
            7: "7月は、内面の安定が重要となる月です。着実な成長が運気を高めます。",
            8: "8月は、着実な努力が認められる月です。責任ある立場での活躍が期待できます。",
            9: "9月は、完成と新たな始まりの月です。これまでの努力が実を結びます。",
            10: "10月は、計画的な行動が成果を生む月です。着実に目標を達成しましょう。",
            11: "11月は、大きなプロジェクトの基盤を築く月です。理想を現実化する準備が整います。",
            12: "12月は、安定した成果を手に入れる月です。誠実さと責任感が、成功をもたらします。"
        },
        5: {
            1: "1月は、変化と自由の月です。新しい環境や経験が、運気を高めます。",
            2: "2月は、新しい出会いのチャンスが訪れる月です。自由な心で出会いを楽しみましょう。",
            3: "3月は、新しい表現方法に挑戦する月です。創造性が開花します。",
            4: "4月は、変化に対応する月です。柔軟な姿勢が運気を高めます。",
            5: "5月は、自由を楽しむ月です。新しい挑戦が運気を高めます。",
            6: "6月は、変化と成長の月です。新しい環境が、運気を高めます。",
            7: "7月は、内面の変化が重要となる月です。新しい探求が運気を高めます。",
            8: "8月は、変化とチャレンジの月です。新しい分野への挑戦が運気を高めます。",
            9: "9月は、完成と新たな始まりの月です。これまでの変化が実を結びます。",
            10: "10月は、直感に従って変化する月です。スピリチュアルな導きに従いましょう。",
            11: "11月は、大きなビジョンに向けて変化する月です。理想を現実化する準備が整います。",
            12: "12月は、変化と成長の月です。新しい年への準備が整います。"
        },
        6: {
            1: "1月は、愛情と調和の月です。人間関係が深まり、心の豊かさが増します。",
            2: "2月は、愛情が深まる月です。家族やパートナーとの絆が強くなります。",
            3: "3月は、コミュニケーションが重要となる月です。楽しい会話で関係が深まります。",
            4: "4月は、安定した関係を築く月です。誠実さと信頼が、運気を高めます。",
            5: "5月は、新しい出会いのチャンスが訪れる月です。自由な心で出会いを楽しみましょう。",
            6: "6月は、愛情が最も深まる月です。家族やパートナーとの絆が、より強く深くなります。",
            7: "7月は、内面の成長が対人運を高める月です。深いつながりを求めましょう。",
            8: "8月は、サービス精神が評価される月です。人のために働くことで、成果が得られます。",
            9: "9月は、完成と新たな始まりの月です。これまでの愛情が実を結びます。",
            10: "10月は、直感に従うことで素晴らしい出会いがある月です。内なる声を信じましょう。",
            11: "11月は、理想的なパートナーシップが実現する月です。これまでに描いてきた理想の関係が、現実のものとなります。",
            12: "12月は、深い愛情と理解に満ちた関係が築かれる月です。優しさと慈愛が、絆を深めます。"
        },
        7: {
            1: "1月は、内面の探求の月です。スピリチュアルな成長と深い洞察が得られます。",
            2: "2月は、内面の成長が対人運を高める月です。深いつながりを求めましょう。",
            3: "3月は、内面の創造性が開花する月です。スピリチュアルな表現が運気を高めます。",
            4: "4月は、内面の安定が重要となる月です。着実な成長が運気を高めます。",
            5: "5月は、内面の変化が重要となる月です。新しい探求が運気を高めます。",
            6: "6月は、内面の成長が対人運を高める月です。深いつながりを求めましょう。",
            7: "7月は、内面の探求が最も深まる月です。スピリチュアルな成長と深い洞察が得られます。",
            8: "8月は、分析力と研究が光る月です。専門性を高めることで、評価が上がります。",
            9: "9月は、完成と新たな始まりの月です。これまでの内面の成長が実を結びます。",
            10: "10月は、直感とインスピレーションが強く働く月です。スピリチュアルな導きが、人生を導きます。",
            11: "11月は、大きなビジョンに向けて内面を整える月です。理想を現実化する準備が整います。",
            12: "12月は、内面の成長が多くの人々に影響を与える月です。スピリチュアルな導き手としての資質が開花します。"
        },
        8: {
            1: "1月は、成功と達成の月です。ビジネスやキャリアにおいて、大きな飛躍が期待できます。",
            2: "2月は、協力関係が成果を生む月です。チームワークが重要となります。",
            3: "3月は、創造的な仕事で評価される月です。アイデアが次々と実現します。",
            4: "4月は、着実な努力が認められる月です。責任ある立場での活躍が期待できます。",
            5: "5月は、変化とチャレンジの月です。新しい分野への挑戦が運気を高めます。",
            6: "6月は、サービス精神が評価される月です。人のために働くことで、成果が得られます。",
            7: "7月は、分析力と研究が光る月です。専門性を高めることで、評価が上がります。",
            8: "8月は、成功と達成が最も期待できる月です。ビジネスで大きな成功を収められます。",
            9: "9月は、完成と新たな始まりの月です。これまでの努力が実を結びます。",
            10: "10月は、インスピレーションが仕事を導く月です。直感を信じて行動しましょう。",
            11: "11月は、大きなプロジェクトの成功が期待できる月です。理想を現実化する力が発揮されます。",
            12: "12月は、多くの人々に影響を与える仕事で成功する月です。権威や地位が向上します。"
        },
        9: {
            1: "1月は、完成と新たな始まりの月です。これまでの努力が実を結びます。",
            2: "2月は、理想を追い求める姿勢が対人運を高める月です。博愛主義の姿勢が、多くの人々との関係を深めます。",
            3: "3月は、理想を実現する月です。社会貢献につながる活動が運気を高めます。",
            4: "4月は、安定した成果を手に入れる月です。誠実さと責任感が、成功をもたらします。",
            5: "5月は、変化と成長の月です。新しい環境が、運気を高めます。",
            6: "6月は、愛情深い姿勢が対人運を高める月です。優しさと献身的な姿勢が、多くの人々から愛されます。",
            7: "7月は、内面の成長が対人運を高める月です。深いつながりを求めましょう。",
            8: "8月は、理想を実現する月です。社会貢献につながる仕事で、成果を上げられます。",
            9: "9月は、完成と新たな始まりが最も期待できる月です。これまでの努力が実を結び、次のステップへと進みます。",
            10: "10月は、理想を実現するための準備が整う月です。大きなビジョンに向けて行動しましょう。",
            11: "11月は、大きなビジョン実現の月です。理想を現実化する力が最大限に発揮されます。",
            12: "12月は、多くの人々に影響を与える活動ができる月です。博愛主義の姿勢が、多くの人々に希望を与えます。"
        },
        11: {
            1: "1月は、直感とインスピレーションが強く働く月です。スピリチュアルな導きが、人生を導きます。",
            2: "2月は、直感に従うことで素晴らしい出会いがある月です。内なる声を信じましょう。",
            3: "3月は、インスピレーションが仕事を導く月です。直感を信じて行動しましょう。",
            4: "4月は、直感を信じることで新しいチャンスが訪れる月です。内なる声に耳を傾けましょう。",
            5: "5月は、直感に従って変化する月です。スピリチュアルな導きに従いましょう。",
            6: "6月は、直感に従うことで素晴らしい出会いがある月です。内なる声を信じましょう。",
            7: "7月は、直感とインスピレーションが最も強く働く月です。スピリチュアルな導きが、人生を導きます。",
            8: "8月は、インスピレーションが仕事を導く月です。直感を信じて行動しましょう。",
            9: "9月は、完成と新たな始まりの月です。これまでの直感が実を結びます。",
            10: "10月は、直感とインスピレーションが最も強く働く月です。スピリチュアルな導きが、人生を導きます。",
            11: "11月は、大きなビジョンに向けて直感を信じる月です。理想を現実化する準備が整います。",
            12: "12月は、スピリチュアルな導きが多くの人々に影響を与える月です。直感を信じることで、多くの人々を導けます。"
        },
        22: {
            1: "1月は、大きなビジョン実現の月です。理想を現実化する力が最大限に発揮されます。",
            2: "2月は、理想的なパートナーシップが実現する月です。これまでに描いてきた理想の関係が、現実のものとなります。",
            3: "3月は、大きなビジョンを表現する月です。理想を現実化する力が発揮されます。",
            4: "4月は、大きなプロジェクトの基盤を築く月です。理想を現実化する準備が整います。",
            5: "5月は、大きなビジョンに向けて変化する月です。理想を現実化する準備が整います。",
            6: "6月は、理想的なパートナーシップが実現する月です。これまでに描いてきた理想の関係が、現実のものとなります。",
            7: "7月は、大きなビジョンに向けて内面を整える月です。理想を現実化する準備が整います。",
            8: "8月は、大きなプロジェクトの成功が期待できる月です。理想を現実化する力が発揮されます。",
            9: "9月は、完成と新たな始まりの月です。これまでの大きなビジョンが実を結びます。",
            10: "10月は、大きなビジョンに向けて直感を信じる月です。理想を現実化する準備が整います。",
            11: "11月は、大きなビジョン実現が最も期待できる月です。理想を現実化する力が最大限に発揮されます。",
            12: "12月は、大きなビジョンが多くの人々に影響を与える月です。理想を現実化する力が、多くの人々に希望を与えます。"
        },
        33: {
            1: "1月は、慈愛と癒しの月です。多くの人々に影響を与える特別な月となります。",
            2: "2月は、深い愛情と理解に満ちた関係が築かれる月です。優しさと慈愛が、絆を深めます。",
            3: "3月は、多くの人々に影響を与える表現活動ができる月です。創造性が多くの人々に希望を与えます。",
            4: "4月は、多くの人々に影響を与える活動の基盤を築く月です。理想を現実化する準備が整います。",
            5: "5月は、多くの人々に影響を与える変化が起こる月です。理想を現実化する準備が整います。",
            6: "6月は、深い愛情と理解に満ちた関係が最も深まる月です。優しさと慈愛が、絆を深めます。",
            7: "7月は、多くの人々を導き、癒す月です。スピリチュアルな導き手としての資質が開花します。",
            8: "8月は、多くの人々に影響を与える仕事で成功する月です。慈愛と知恵が、多くの人々に希望を与えます。",
            9: "9月は、完成と新たな始まりの月です。これまでの慈愛と癒しが実を結びます。",
            10: "10月は、多くの人々を導き、癒す月です。スピリチュアルな導き手としての資質が開花します。",
            11: "11月は、大きなビジョンが多くの人々に影響を与える月です。理想を現実化する力が、多くの人々に希望を与えます。",
            12: "12月は、慈愛と癒しが最も深まる月です。多くの人々に影響を与える特別な月となります。"
        }
    }
    # デフォルトの月別運勢（life_pathが見つからない場合）
    default_monthly = {
        1: "1月は、新しいスタートに最適な月です。積極的に行動することで、成果が期待できます。",
        2: "2月は、協力関係が重要となる月です。パートナーシップを大切にすることで、運気が上昇します。",
        3: "3月は、創造性が開花する月です。表現活動を通じて、成功のチャンスが訪れます。",
        4: "4月は、着実な成長の月です。努力を積み重ねることで、安定した成果を得られます。",
        5: "5月は、変化と自由の月です。新しい環境や経験が、運気を高めます。",
        6: "6月は、愛情と調和の月です。人間関係が深まり、心の豊かさが増します。",
        7: "7月は、内面の探求の月です。スピリチュアルな成長と深い洞察が得られます。",
        8: "8月は、成功と達成の月です。ビジネスやキャリアにおいて、大きな飛躍が期待できます。",
        9: "9月は、完成と新たな始まりの月です。これまでの努力が実を結びます。",
        10: "10月は、直感とインスピレーションが強く働く月です。スピリチュアルな導きが、人生を導きます。",
        11: "11月は、大きなビジョン実現の月です。理想を現実化する力が最大限に発揮されます。",
        12: "12月は、慈愛と癒しの月です。多くの人々に影響を与える特別な月となります。"
    }
    return monthly_fortunes.get(life_path, default_monthly)

def get_lucky_color(life_path):
    colors = {1:"ゴールド", 2:"ピンク", 3:"イエロー", 4:"エメラルドグリーン", 5:"ターコイズブルー", 6:"ローズピンク", 7:"パープル", 8:"シルバー", 9:"ロイヤルブルー", 11:"クリスタル", 22:"プラチナ", 33:"レインボー"}
    return colors.get(life_path, "ピンク")

def get_lucky_item(life_path):
    items = {1:"ペンダント", 2:"ハート型のアクセサリー", 3:"アート作品", 4:"実用的なバッグ", 5:"旅行グッズ", 6:"家族の写真", 7:"クリスタル", 8:"高級時計", 9:"記念品", 11:"スピリチュアルなアイテム", 22:"ビジョンボード", 33:"癒しのアイテム"}
    return items.get(life_path, "お守り")

def create_pdf(name, birth_year, birth_month, birth_day):
    """PDFを生成する（2ページ構成版）"""
    life_path = calculate_life_path_number(birth_year, birth_month, birth_day)
    personality = get_personality(life_path)
    overall_fortune, fortune_desc = get_fortune(life_path)
    love_stars, love_advice = get_love_fortune(life_path)
    work_stars, work_advice = get_work_fortune(life_path)
    money_stars, money_advice = get_money_fortune(life_path)
    health_stars, health_advice = get_health_fortune(life_path)
    relationship_stars, relationship_advice = get_relationship_fortune(life_path)
    lucky_color = get_lucky_color(life_path)
    lucky_item = get_lucky_item(life_path)
    monthly_fortunes = get_monthly_fortune(life_path)
    
    filename = f"運勢鑑定書_{name}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pdf"
    
    c = canvas.Canvas(filename, pagesize=A4)
    width, height = A4 
    
    bg_color = HexColor("#FFFBF0")
    text_color = HexColor("#333333")
    accent_color = HexColor("#C0A060")
    title_color = HexColor("#C71585")

    # ==========================================
    # 1ページ目
    # ==========================================
    c.setFillColor(bg_color)
    c.rect(0, 0, width, height, fill=1)
    
    if register_font():
        font_name = 'IPAexMincho'
    else:
        font_name = 'Helvetica'
    
    margin = 50          
    content_width = width - (margin * 2) 
    current_y = height - 60 

    # タイトル
    c.setFillColor(title_color)
    c.setFont(font_name, 26)
    c.drawCentredString(width/2, current_y, "2026年 運勢鑑定書")
    current_y -= 40
    
    # 名前
    c.setFillColor(accent_color)
    c.setFont(font_name, 22)
    c.drawCentredString(width/2, current_y, f"{name} 様")
    current_y -= 30
    
    # 生年月日
    c.setFillColor(text_color)
    c.setFont(font_name, 12)
    c.drawCentredString(width/2, current_y, f"生年月日: {birth_year}年{birth_month}月{birth_day}日")
    current_y -= 40

    # ライフパスナンバー
    c.setFillColor(title_color)
    c.setFont(font_name, 18)
    c.drawCentredString(width/2, current_y, f"ライフパスナンバー：{life_path}")
    current_y -= 40

    # 性格（自動折り返し）
    current_y = draw_wrapped_text(c, personality, margin, current_y, content_width, font_name, 11, 18, text_color)
    current_y -= 30 

    # 総合運
    c.setFillColor(title_color)
    c.setFont(font_name, 16)
    c.drawString(margin, current_y, "【総合運】")
    current_y -= 25
    
    c.setFillColor(accent_color)
    c.setFont(font_name, 20)
    c.drawString(margin, current_y, overall_fortune)
    current_y -= 25
    
    current_y = draw_wrapped_text(c, fortune_desc, margin, current_y, content_width, font_name, 11, 18, text_color)
    current_y -= 30

    # 恋愛運
    c.setFillColor(title_color)
    c.setFont(font_name, 16)
    c.drawString(margin, current_y, "【恋愛運】")
    current_y -= 25
    
    c.setFillColor(accent_color)
    c.setFont(font_name, 16)
    stars = "★" * love_stars + "☆" * (5 - love_stars)
    c.drawString(margin, current_y, stars)
    current_y -= 25
    
    current_y = draw_wrapped_text(c, love_advice, margin, current_y, content_width, font_name, 11, 18, text_color)
    current_y -= 30

    # 仕事運
    c.setFillColor(title_color)
    c.setFont(font_name, 16)
    c.drawString(margin, current_y, "【仕事運】")
    current_y -= 25
    
    c.setFillColor(accent_color)
    c.setFont(font_name, 16)
    stars = "★" * work_stars + "☆" * (5 - work_stars)
    c.drawString(margin, current_y, stars)
    current_y -= 25
    
    current_y = draw_wrapped_text(c, work_advice, margin, current_y, content_width, font_name, 11, 18, text_color)
    current_y -= 30

    # 金運（新規）
    c.setFillColor(title_color)
    c.setFont(font_name, 16)
    c.drawString(margin, current_y, "【金運】")
    current_y -= 25
    
    c.setFillColor(accent_color)
    c.setFont(font_name, 16)
    stars = "★" * money_stars + "☆" * (5 - money_stars)
    c.drawString(margin, current_y, stars)
    current_y -= 25
    
    current_y = draw_wrapped_text(c, money_advice, margin, current_y, content_width, font_name, 11, 18, text_color)
    current_y -= 30

    # 健康運（新規）
    c.setFillColor(title_color)
    c.setFont(font_name, 16)
    c.drawString(margin, current_y, "【健康運】")
    current_y -= 25
    
    c.setFillColor(accent_color)
    c.setFont(font_name, 16)
    stars = "★" * health_stars + "☆" * (5 - health_stars)
    c.drawString(margin, current_y, stars)
    current_y -= 25
    
    current_y = draw_wrapped_text(c, health_advice, margin, current_y, content_width, font_name, 11, 18, text_color)
    current_y -= 30

    # 対人運（新規）
    c.setFillColor(title_color)
    c.setFont(font_name, 16)
    c.drawString(margin, current_y, "【対人運】")
    current_y -= 25
    
    c.setFillColor(accent_color)
    c.setFont(font_name, 16)
    stars = "★" * relationship_stars + "☆" * (5 - relationship_stars)
    c.drawString(margin, current_y, stars)
    current_y -= 25
    
    current_y = draw_wrapped_text(c, relationship_advice, margin, current_y, content_width, font_name, 11, 18, text_color)
    current_y -= 30

    # ラッキーカラー・アイテム
    c.setFillColor(title_color)
    c.setFont(font_name, 14)
    c.drawString(margin, current_y, f"ラッキーカラー： {lucky_color}")
    current_y -= 25
    c.drawString(margin, current_y, f"ラッキーアイテム： {lucky_item}")

    # ==========================================
    # 2ページ目（月別運勢カレンダー）
    # ==========================================
    c.showPage()
    
    # 背景
    c.setFillColor(bg_color)
    c.rect(0, 0, width, height, fill=1)
    
    current_y = height - 60
    
    # タイトル
    c.setFillColor(title_color)
    c.setFont(font_name, 24)
    c.drawCentredString(width/2, current_y, "2026年 月別運勢カレンダー")
    current_y -= 50
    
    # 月別運勢をリスト形式で表示
    months = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"]
    
    for i, month_name in enumerate(months, 1):
        # 月名
        c.setFillColor(title_color)
        c.setFont(font_name, 14)
        c.drawString(margin, current_y, f"{month_name}")
        current_y -= 20
        
        # 運勢テキスト
        month_fortune = monthly_fortunes.get(i, "")
        if month_fortune:
            current_y = draw_wrapped_text(c, month_fortune, margin + 20, current_y, content_width - 20, font_name, 10, 16, text_color)
            current_y -= 15
        else:
            current_y -= 15
        
        # ページを超える場合は改ページ（ただし最後の月は除く）
        if current_y < 80 and i < 12:
            c.showPage()
            c.setFillColor(bg_color)
            c.rect(0, 0, width, height, fill=1)
            current_y = height - 60
    
    # フッター
    c.setFillColor(HexColor("#999999"))
    c.setFont(font_name, 9)
    c.drawCentredString(width/2, 30, "この鑑定書は数秘術に基づいて作成されました。")
    
    c.save()
    return filename

# ==========================================
# Stripe決済対応のUI
# ==========================================
st.title("2026年 運勢鑑定書発行アプリ")
st.markdown("---")

if not os.path.exists(FONT_PATH):
    download_font()

# -------------------------------------------
# 決済状態のチェック
# -------------------------------------------
# URLに "?paid=true" がついているか確認
query_params = st.query_params
is_paid = query_params.get("paid") == "true"

# -------------------------------------------
# パターンA：まだ支払っていない場合
# -------------------------------------------
if not is_paid:
    st.info("👋 ようこそ！まずは無料プレビューをご覧ください。")
    
    # 無料版の入力フォーム（雰囲気だけ）
    with st.form("preview_form"):
        st.write("### 🔮 無料プレビュー入力")
        st.caption("名前を入力して「鑑定結果の一部を見る」を押してください")
        name = st.text_input("お名前", placeholder="山田 花子")
        col1, col2, col3 = st.columns(3)
        with col1: st.number_input("年", 1900, 2024, 2000)
        with col2: st.number_input("月", 1, 12, 1)
        with col3: st.number_input("日", 1, 31, 1)
        
        submitted = st.form_submit_button("鑑定結果の一部を見る")
    
    if submitted:
        st.warning("🔒 ここから先は「完全版」の購入が必要です。")
        st.markdown(f"**{name}** 様の「ライフパスナンバー」や「2026年の詳細な運勢」を知るには、鑑定書を発行してください。")

    st.markdown("---")
    st.header("💎 完全版鑑定書 (PDF)")
    st.write("2026年の総合運、恋愛運、仕事運、ラッキーカラーなどを網羅したあなただけの鑑定書を発行します。")
    
    # ▼▼▼【重要】ここにStripeのURLを貼り付けてください！▼▼▼
    stripe_url = "https://buy.stripe.com/test_eVq9AT1BwaGu813acfcfK03" 
    
    st.link_button(
        label="👉 500円で鑑定書を発行する", 
        url=stripe_url, 
        type="primary", 
        use_container_width=True
    )

# -------------------------------------------
# パターンB：支払い完了後（鑑定書発行画面）
# -------------------------------------------
else:
    st.success("✅ ご購入ありがとうございます！鑑定書を発行できます。")
    
    with st.form("fortune_form"):
        st.write("### 📄 鑑定書発行フォーム")
        st.write("もう一度、正確な情報を入力してください。")
        name = st.text_input("お名前", placeholder="山田 花子")
        col1, col2, col3 = st.columns(3)
        with col1: birth_year = st.number_input("年", 1900, 2024, 2000)
        with col2: birth_month = st.number_input("月", 1, 12, 1)
        with col3: birth_day = st.number_input("日", 1, 31, 1)
        
        submitted = st.form_submit_button("鑑定書PDFをダウンロードする", use_container_width=True)

    if submitted and name:
        with st.spinner("鑑定書を生成中..."):
            try:
                pdf_file = create_pdf(name, birth_year, birth_month, birth_day)
                with open(pdf_file, "rb") as f:
                    st.download_button(
                        label="📥 PDFをダウンロード", 
                        data=f, 
                        file_name=pdf_file, 
                        mime="application/pdf",
                        type="primary"
                    )
                st.balloons()
            except Exception as e:
                st.error(f"エラーが発生しました: {e}")